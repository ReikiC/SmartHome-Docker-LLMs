<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Load configuration and modules -->
    <script src="js/config.js"></script>
    <script src="js/api-client.js"></script>
    <script src="js/main.js"></script>
</head>
<body>
    <!-- Mode Switcher -->
    <div class="mode-switcher">
        <a href="developer.html" class="mode-btn">
            <i class="bi bi-code-slash"></i> Developer Mode
        </a>
        <a href="index.html" class="mode-btn active">
            <i class="bi bi-house-heart"></i> User Mode
        </a>
    </div>

    <div class="container-fluid">
        <!-- Header -->
        <header class="text-center my-4">
            <h1 class="text-white mb-3">
                <i class="bi bi-robot"></i> Smart Home Assistant
            </h1>
            <p class="lead text-white-50">
                Control your smart home with voice and touch
            </p>
        </header>

        <!-- Quick Scene Controls -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-lightning-charge"></i> Quick Scenes</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2 col-6 mb-3">
                                <div class="scene-card" onclick="executeScene('home_mode')">
                                    <div class="scene-icon">
                                        <i class="bi bi-house-door"></i>
                                    </div>
                                    <h6>Home</h6>
                                    <small class="text-muted">Welcome back</small>
                                </div>
                            </div>
                            <div class="col-md-2 col-6 mb-3">
                                <div class="scene-card" onclick="executeScene('sleep_mode')">
                                    <div class="scene-icon">
                                        <i class="bi bi-moon-stars"></i>
                                    </div>
                                    <h6>Sleep</h6>
                                    <small class="text-muted">Good night</small>
                                </div>
                            </div>
                            <div class="col-md-2 col-6 mb-3">
                                <div class="scene-card" onclick="executeScene('work_mode')">
                                    <div class="scene-icon">
                                        <i class="bi bi-laptop"></i>
                                    </div>
                                    <h6>Work</h6>
                                    <small class="text-muted">Focus time</small>
                                </div>
                            </div>
                            <div class="col-md-2 col-6 mb-3">
                                <div class="scene-card" onclick="executeScene('movie_mode')">
                                    <div class="scene-icon">
                                        <i class="bi bi-camera-reels"></i>
                                    </div>
                                    <h6>Movie</h6>
                                    <small class="text-muted">Relax & watch</small>
                                </div>
                            </div>
                            <div class="col-md-2 col-6 mb-3">
                                <div class="scene-card" onclick="executeScene('cooking_mode')">
                                    <div class="scene-icon">
                                        <i class="bi bi-fire"></i>
                                    </div>
                                    <h6>Cooking</h6>
                                    <small class="text-muted">Chef mode</small>
                                </div>
                            </div>
                            <div class="col-md-2 col-6 mb-3">
                                <div class="scene-card" onclick="executeScene('away_mode')">
                                    <div class="scene-icon">
                                        <i class="bi bi-shield-lock"></i>
                                    </div>
                                    <h6>Away</h6>
                                    <small class="text-muted">Secure home</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Room Selection -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-geo-alt"></i> Select Room</h5>
                    </div>
                    <div class="card-body">
                        <div class="room-tabs" id="room-tabs">
                            <div class="room-tab active" data-room="living_room" onclick="selectRoom('living_room')">
                                <i class="bi bi-tv"></i> Living Room
                            </div>
                            <div class="room-tab" data-room="bedroom" onclick="selectRoom('bedroom')">
                                <i class="bi bi-moon"></i> Bedroom
                            </div>
                            <div class="room-tab" data-room="kitchen" onclick="selectRoom('kitchen')">
                                <i class="bi bi-cup-hot"></i> Kitchen
                            </div>
                            <div class="room-tab" data-room="study" onclick="selectRoom('study')">
                                <i class="bi bi-book"></i> Study
                            </div>
                            <div class="room-tab" data-room="bathroom" onclick="selectRoom('bathroom')">
                                <i class="bi bi-droplet"></i> Bathroom
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Voice Interaction and Room Status -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-mic"></i> Voice Assistant</h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <button id="voice-btn" class="btn btn-primary btn-lg" onclick="toggleVoiceRecording()">
                                <i class="bi bi-mic-fill"></i> Tap to Speak
                            </button>
                        </div>
                        
                        <div class="mb-3">
                            <label for="user-input" class="form-label">Or type your request:</label>
                            <div class="input-group">
                                <input type="text" id="user-input" class="form-control" placeholder="Turn on living room lights..." onkeypress="handleEnterKey(event)">
                                <button class="btn btn-primary" onclick="sendText()">
                                    <i class="bi bi-send"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <h6>Conversation:</h6>
                            <div id="chat-history" class="chat-area" style="min-height: 250px;"></div>
                        </div>
                        
                        <div class="mt-3" id="audio-player-container" style="display: none;">
                            <audio id="audio-player" controls style="width: 100%;"></audio>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Room Status and Quick Controls -->
            <div class="col-md-4">
                <!-- Environment Status -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5><i class="bi bi-thermometer-half"></i> Environment</h5>
                    </div>
                    <div class="card-body">
                        <div id="environment-status">
                            <div class="environment-item">
                                <span><i class="bi bi-thermometer"></i> Temperature:</span>
                                <span class="environment-value" id="temp-display">23.5Â°C</span>
                            </div>
                            <div class="environment-item">
                                <span><i class="bi bi-droplet"></i> Humidity:</span>
                                <span class="environment-value" id="humidity-display">55%</span>
                            </div>
                            <div class="environment-item">
                                <span><i class="bi bi-wind"></i> Air Quality:</span>
                                <span class="environment-value" id="air-quality-display">Good</span>
                            </div>
                            <div class="environment-item">
                                <span><i class="bi bi-brightness-high"></i> Light Level:</span>
                                <span class="environment-value" id="light-display">300 lux</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Controls -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-toggles"></i> Quick Controls</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="quickControl('ceiling_light', 'toggle')" id="light-btn">
                                <i class="bi bi-lightbulb"></i> <span id="light-text">Toggle Lights</span>
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="quickControl('ac', 'toggle')" id="ac-btn">
                                <i class="bi bi-snow"></i> <span id="ac-text">Toggle AC</span>
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="quickControl('fan', 'toggle')" id="fan-btn">
                                <i class="bi bi-fan"></i> <span id="fan-text">Toggle Fan</span>
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="quickControl('curtain', 'toggle')" id="curtain-btn">
                                <i class="bi bi-window"></i> <span id="curtain-text">Toggle Curtains</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Device Status Grid -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-grid-3x3-gap"></i> Device Status - <span id="current-room-display">Living Room</span></h5>
                    </div>
                    <div class="card-body">
                        <div class="device-grid" id="device-grid">
                            <!-- Device cards will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="text-center mt-4 mb-5">
            <p class="text-white-50">Smart Home Assistant &copy; 2025</p>
        </footer>
    </div>

    <!-- User Mode JavaScript -->
    <script>
        // Global variables
        let isRecording = false;
        let currentRoom = 'living_room';
        let currentDeviceStates = {};

        // Room selection
        function selectRoom(room) {
            currentRoom = room;
            
            // Update active tab
            document.querySelectorAll('.room-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-room="${room}"]`).classList.add('active');
            
            // Update display
            const roomNames = {
                'living_room': 'Living Room',
                'bedroom': 'Bedroom',
                'kitchen': 'Kitchen',
                'study': 'Study',
                'bathroom': 'Bathroom'
            };
            document.getElementById('current-room-display').textContent = roomNames[room];
            
            // Update environment and device status
            updateEnvironmentStatus();
            updateDeviceGrid();
        }

        // Scene execution
        function executeScene(sceneName) {
            addMessageToChat('user', `Executing ${sceneName.replace('_', ' ')} mode...`);
            
            fetch(`${API_URLS.coordinator}/execute_scene`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ scene_name: sceneName, location: currentRoom })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    addMessageToChat('ai', `${sceneName.replace('_', ' ')} mode activated successfully!`);
                } else {
                    addMessageToChat('ai', `Failed to activate ${sceneName.replace('_', ' ')} mode.`);
                }
                updateEnvironmentStatus();
                updateDeviceGrid();
            })
            .catch(error => {
                addMessageToChat('ai', `Error executing scene: ${error.message}`);
            });
        }

        // Voice recording with real STT
        function toggleVoiceRecording() {
            const btn = document.getElementById('voice-btn');
            if (!isRecording) {
                startVoiceRecording(btn);
            } else {
                stopVoiceRecording(btn);
            }
        }

        async function startVoiceRecording(btn) {
            try {
                // Check if browser supports audio recording
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    addMessageToChat('system', 'Voice recording not supported in this browser.');
                    return;
                }

                // Request microphone access
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                isRecording = true;
                btn.innerHTML = '<i class="bi bi-stop-fill"></i> Stop Recording';
                btn.classList.add('voice-recording', 'btn-danger');
                btn.classList.remove('btn-primary');
                
                addMessageToChat('system', 'Recording... Speak now!');
                
                // Initialize MediaRecorder
                const mediaRecorder = new MediaRecorder(stream);
                const audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    await processAudioBlob(audioBlob);
                    
                    // Stop all tracks to free up microphone
                    stream.getTracks().forEach(track => track.stop());
                };
                
                // Start recording
                mediaRecorder.start();
                
                // Store mediaRecorder for stopping
                window.currentMediaRecorder = mediaRecorder;
                
                // Auto-stop after 10 seconds
                setTimeout(() => {
                    if (isRecording && mediaRecorder.state === 'recording') {
                        stopVoiceRecording(btn);
                    }
                }, 10000);
                
            } catch (error) {
                console.error('Error starting voice recording:', error);
                addMessageToChat('system', `Voice recording error: ${error.message}`);
                resetVoiceButton(btn);
            }
        }

        function stopVoiceRecording(btn) {
            if (window.currentMediaRecorder && window.currentMediaRecorder.state === 'recording') {
                window.currentMediaRecorder.stop();
            }
            resetVoiceButton(btn);
        }

        function resetVoiceButton(btn) {
            isRecording = false;
            btn.innerHTML = '<i class="bi bi-mic-fill"></i> Tap to Speak';
            btn.classList.remove('voice-recording', 'btn-danger');
            btn.classList.add('btn-primary');
        }

        async function processAudioBlob(audioBlob) {
            addMessageToChat('system', 'Processing voice...');
            
            try {
                // Create FormData for file upload
                const formData = new FormData();
                formData.append('file', audioBlob, 'recording.wav');
                
                // Upload to STT service
                const response = await fetch(`${API_URLS.stt}/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`STT service error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.text && data.text.trim()) {
                    const recognizedText = data.text.trim();
                    addMessageToChat('user', recognizedText);
                    sendTextMessage(recognizedText);
                } else {
                    addMessageToChat('system', 'Could not recognize speech. Please try again.');
                }
                
            } catch (error) {
                console.error('Error processing audio:', error);
                addMessageToChat('system', `Speech recognition failed: ${error.message}`);
            }
        }

        // Fallback voice command for demo purposes
        function processVoiceCommand(text) {
            addMessageToChat('user', text);
            sendTextMessage(text);
        }

        // Text input
        function sendText() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text) return;
            
            addMessageToChat('user', text);
            input.value = '';
            sendTextMessage(text);
        }

        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                sendText();
            }
        }

        async function sendTextMessage(text) {
            const thinkingId = addMessageToChat('ai', 'Thinking...');
            
            try {
                const response = await fetch(`${API_URLS.coordinator}/process_text`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    updateChatMessage(thinkingId, data.ai_response);
                    
                    if (data.iot_commands && data.iot_commands.length > 0) {
                        let iotInfo = 'Executed commands:<br>';
                        data.iot_commands.forEach(cmd => {
                            if (cmd.type === 'scene') {
                                iotInfo += `- Scene: ${cmd.scene}<br>`;
                            } else {
                                iotInfo += `- ${cmd.device} (${cmd.location}): ${cmd.action}<br>`;
                            }
                        });
                        addMessageToChat('system', iotInfo);
                    }
                    
                    if (data.audio_path) {
                        const audioServer = API_URLS.tts;
                        const audioFilename = data.audio_path.split('/').pop();
                        const audioUrl = `${audioServer}/audio/${audioFilename}`;
                        
                        const audioPlayer = document.getElementById('audio-player');
                        audioPlayer.src = audioUrl;
                        document.getElementById('audio-player-container').style.display = 'block';
                        
                        audioPlayer.play().catch(err => {
                            console.error('Auto-play failed:', err);
                            addMessageToChat('system', 'Audio ready. Click play button to listen.');
                        });
                    }
                    
                    updateEnvironmentStatus();
                    updateDeviceGrid();
                } else {
                    updateChatMessage(thinkingId, `Processing failed: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                updateChatMessage(thinkingId, `Request error: ${error.message}`);
            }
        }

        // Quick controls
        function quickControl(device, action) {
            let deviceAction = action;
            
            if (action === 'toggle') {
                const currentState = currentDeviceStates[device]?.[currentRoom]?.status || 'off';
                deviceAction = currentState === 'on' ? 'off' : 'on';
            }
            
            fetch(`${API_URLS.iot}/control`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    commands: [{ device: device, action: deviceAction, location: currentRoom }]
                })
            })
            .then(response => response.json())
            .then(data => {
                updateEnvironmentStatus();
                updateDeviceGrid();
                updateQuickControlButtons();
                addMessageToChat('system', `${device} in ${currentRoom} ${deviceAction}`);
            })
            .catch(error => {
                addMessageToChat('system', `Error controlling device: ${error.message}`);
            });
        }

        // Update environment status
        function updateEnvironmentStatus() {
            fetch(`${API_URLS.iot}/sensors/${currentRoom}`)
                .then(response => response.json())
                .then(data => {
                    if (data.sensors) {
                        document.getElementById('temp-display').textContent = `${data.sensors.temperature}Â°C`;
                        document.getElementById('humidity-display').textContent = `${data.sensors.humidity}%`;
                        document.getElementById('light-display').textContent = `${data.sensors.light_level} lux`;
                        
                        // Calculate air quality
                        const co2 = data.sensors.co2;
                        let airQuality = 'Good';
                        if (co2 > 800) airQuality = 'Poor';
                        else if (co2 > 600) airQuality = 'Fair';
                        document.getElementById('air-quality-display').textContent = airQuality;
                    }
                })
                .catch(error => console.error('Error updating environment:', error));
            
            // Update device states
            fetch(`${API_URLS.iot}/devices`)
                .then(response => response.json())
                .then(data => {
                    currentDeviceStates = data.devices;
                    updateQuickControlButtons();
                })
                .catch(error => console.error('Error updating device states:', error));
        }

        // Update quick control buttons
        function updateQuickControlButtons() {
            const devices = ['ceiling_light', 'ac', 'fan', 'curtain'];
            const buttonTexts = {
                'ceiling_light': 'light',
                'ac': 'ac',
                'fan': 'fan',
                'curtain': 'curtain'
            };

            devices.forEach(device => {
                const state = currentDeviceStates[device]?.[currentRoom]?.status || 'off';
                const button = document.getElementById(`${buttonTexts[device]}-btn`);
                const text = document.getElementById(`${buttonTexts[device]}-text`);
                
                if (button && text) {
                    if (state === 'on' || state === 'open') {
                        button.classList.remove('btn-outline-primary', 'btn-outline-success', 'btn-outline-info', 'btn-outline-warning');
                        button.classList.add('btn-primary');
                        text.textContent = `Turn Off ${device.replace('_', ' ').replace('ceiling light', 'Lights')}`;
                    } else {
                        button.classList.remove('btn-primary', 'btn-success', 'btn-info', 'btn-warning');
                        button.classList.add('btn-outline-primary');
                        text.textContent = `Turn On ${device.replace('_', ' ').replace('ceiling light', 'Lights')}`;
                    }
                }
            });
        }

        // Update device grid
        function updateDeviceGrid() {
            const grid = document.getElementById('device-grid');
            if (!grid) return;

            const deviceConfig = {
                'ceiling_light': { icon: 'lightbulb', name: 'Ceiling Light' },
                'desk_lamp': { icon: 'lamp', name: 'Desk Lamp' },
                'fan': { icon: 'fan', name: 'Fan' },
                'exhaust_fan': { icon: 'wind', name: 'Exhaust Fan' },
                'ac': { icon: 'snow', name: 'Air Conditioner' },
                'curtain': { icon: 'window', name: 'Curtain' }
            };

            grid.innerHTML = '';

            Object.keys(deviceConfig).forEach(deviceType => {
                const deviceState = currentDeviceStates[deviceType]?.[currentRoom];
                if (!deviceState) return;

                const config = deviceConfig[deviceType];
                const isActive = deviceState.status === 'on' || deviceState.status === 'open';

                const deviceCard = document.createElement('div');
                deviceCard.className = `device-card ${isActive ? 'active' : ''}`;
                deviceCard.onclick = () => quickControl(deviceType, 'toggle');

                let statusText = isActive ? 'On' : 'Off';
                let additionalInfo = '';

                // Add specific information based on device type
                if (deviceType === 'ceiling_light' || deviceType === 'desk_lamp') {
                    if (deviceState.brightness !== undefined) {
                        additionalInfo = `<br><small>Brightness: ${deviceState.brightness}%</small>`;
                    }
                } else if (deviceType === 'fan' || deviceType === 'exhaust_fan') {
                    if (deviceState.speed !== undefined && isActive) {
                        additionalInfo = `<br><small>Speed: ${deviceState.speed}</small>`;
                    }
                } else if (deviceType === 'ac') {
                    if (deviceState.temperature !== undefined) {
                        additionalInfo = `<br><small>Temp: ${deviceState.temperature}Â°C</small>`;
                    }
                } else if (deviceType === 'curtain') {
                    if (deviceState.position !== undefined) {
                        statusText = `${deviceState.position}% Open`;
                        additionalInfo = '';
                    }
                }

                deviceCard.innerHTML = `
                    <div class="device-icon">
                        <i class="bi bi-${config.icon}"></i>
                    </div>
                    <h6>${config.name}</h6>
                    <p class="mb-0">${statusText}${additionalInfo}</p>
                `;

                grid.appendChild(deviceCard);
            });
        }

        // Chat functions
        function addMessageToChat(type, text) {
            const chatHistory = document.getElementById('chat-history');
            const messageId = 'msg-' + Date.now() + '-' + Math.random();
            
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.className = `chat-message ${type}`;
            
            const messageP = document.createElement('p');
            
            if (type === 'system') {
                messageP.innerHTML = text;
            } else {
                messageP.textContent = text;
            }
            
            messageDiv.appendChild(messageP);
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            return messageId;
        }

        function updateChatMessage(messageId, text) {
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                messageElement.querySelector('p').textContent = text;
                const chatHistory = messageElement.parentElement;
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateEnvironmentStatus();
            updateDeviceGrid();
            
            // Auto-refresh every 30 seconds
            setInterval(updateEnvironmentStatus, 30000);
            
            console.log('Smart Home User Interface loaded');
        });
    </script>
</body>
</html>