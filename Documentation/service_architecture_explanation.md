# Smart Home System - æœåŠ¡æ¶æ„ä¸WebSocketç®¡ç†è¯¦è§£

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ€»è§ˆ

ä½ çš„æ™ºèƒ½å®¶å±…ç³»ç»Ÿé‡‡ç”¨**å¾®æœåŠ¡æ¶æ„**ï¼Œå…±æœ‰5ä¸ªæ ¸å¿ƒæœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡éƒ½æœ‰ç‹¬ç«‹çš„èŒè´£ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸŒ ç”¨æˆ·ç•Œé¢å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Web Browser   â”‚  â”‚   ESP8266/32    â”‚  â”‚  Mobile App  â”‚ â”‚
â”‚  â”‚  (Port 1145)    â”‚  â”‚   Devices       â”‚  â”‚              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ğŸ¯ åè°ƒæœåŠ¡ (ä¸»æ§åˆ¶å™¨)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚           Coordinator Service (Port 8080)              â”‚ â”‚
â”‚  â”‚  â€¢ WebSocket ä¸»ç®¡ç†å™¨ (/ws)                             â”‚ â”‚
â”‚  â”‚  â€¢ HTTP API æ¥å£                                       â”‚ â”‚
â”‚  â”‚  â€¢ æœåŠ¡é—´é€šä¿¡åè°ƒ                                        â”‚ â”‚
â”‚  â”‚  â€¢ è¯­ä¹‰ç†è§£ä¸å¤„ç†                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ğŸ”§ å¾®æœåŠ¡å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚STT Service  â”‚  â”‚TTS Service  â”‚  â”‚IoT Control  â”‚         â”‚
â”‚  â”‚(Port 8000)  â”‚  â”‚(Port 8001)  â”‚  â”‚(Port 8002)  â”‚         â”‚
â”‚  â”‚â€¢ è¯­éŸ³è¯†åˆ«    â”‚  â”‚â€¢ è¯­éŸ³åˆæˆ    â”‚  â”‚â€¢ è®¾å¤‡æ§åˆ¶    â”‚         â”‚
â”‚  â”‚â€¢ éŸ³é¢‘å¤„ç†    â”‚  â”‚â€¢ éŸ³é¢‘ç”Ÿæˆ    â”‚  â”‚â€¢ çŠ¶æ€ç®¡ç†    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â€¢ WebSocket   â”‚         â”‚
â”‚                                    â”‚  (/ws)      â”‚         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚  â”‚        Ollama Service           â”‚                        â”‚
â”‚  â”‚        (Port 11434)             â”‚                        â”‚
â”‚  â”‚      â€¢ LLM æ¨ç†å¼•æ“              â”‚                        â”‚
â”‚  â”‚      â€¢ è‡ªç„¶è¯­è¨€å¤„ç†               â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ åè°ƒæœåŠ¡ (Coordinator) - WebSocket ä¸»ç®¡ç†å™¨

### æ ¸å¿ƒèŒè´£
**Coordinator Service** æ˜¯æ•´ä¸ªç³»ç»Ÿçš„**ä¸­å¤®æŒ‡æŒ¥å®˜**ï¼Œä¹Ÿæ˜¯**ä¸»è¦çš„WebSocketç®¡ç†è€…**ï¼š

```python
# services/coordinator/app.py
@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    """ä¸»è¦çš„WebSocketç«¯ç‚¹ - å¤„ç†æ‰€æœ‰å®¢æˆ·ç«¯è¿æ¥"""
    await websocket.accept()
    client_id = id(websocket)
    connected_clients[client_id] = websocket
    
    # å¤„ç†æ‰€æœ‰ç±»å‹çš„å®¢æˆ·ç«¯æ¶ˆæ¯
    while True:
        data = await websocket.receive_text()
        message = json.loads(data)
        
        if message_type == "text":
            # æ–‡æœ¬å¤„ç† â†’ è°ƒç”¨å…¶ä»–æœåŠ¡
            response = await process_text_with_enhanced_llm(message["text"])
            await websocket.send_json(response)
        
        elif message_type == "audio_ready":
            # éŸ³é¢‘å¤„ç† â†’ è°ƒç”¨STTæœåŠ¡
            response = await process_audio(message["path"])
            await websocket.send_json(response)
        
        elif message_type == "scene_command":
            # åœºæ™¯æ§åˆ¶ â†’ è°ƒç”¨IoTæœåŠ¡
            results = await execute_scene_mode(message["scene"])
            await websocket.send_json(results)
```

### WebSocketè¿æ¥ç®¡ç†
1. **æ¥å—æ‰€æœ‰å®¢æˆ·ç«¯è¿æ¥** (æµè§ˆå™¨ã€ESP8266ã€ç§»åŠ¨åº”ç”¨)
2. **ç»´æŠ¤è¿æ¥æ± ** - è·Ÿè¸ªæ‰€æœ‰æ´»è·ƒè¿æ¥
3. **æ¶ˆæ¯è·¯ç”±** - æ ¹æ®æ¶ˆæ¯ç±»å‹åˆ†å‘åˆ°ç›¸åº”æœåŠ¡
4. **å“åº”èšåˆ** - æ”¶é›†å„æœåŠ¡å“åº”å¹¶è¿”å›ç»™å®¢æˆ·ç«¯

---

## ğŸ  IoTæ§åˆ¶æœåŠ¡ - è®¾å¤‡çŠ¶æ€WebSocket

### è¾…åŠ©WebSocketç®¡ç†
**IoT Control Service** æä¾›**è®¾å¤‡ä¸“ç”¨çš„WebSocket**ï¼š

```python
# services/iot/app.py
@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    """IoTä¸“ç”¨WebSocket - å®æ—¶è®¾å¤‡çŠ¶æ€æ›´æ–°"""
    await websocket.accept()
    
    # å‘é€åˆå§‹è®¾å¤‡çŠ¶æ€
    await websocket.send_json({
        "type": "init",
        "devices": device_states,
        "sensors": sensor_data
    })
    
    # å®æ—¶å¹¿æ’­è®¾å¤‡çŠ¶æ€å˜åŒ–
    while True:
        # ç›‘å¬è®¾å¤‡çŠ¶æ€å˜åŒ–
        if device_state_changed:
            await broadcast_device_update(device, location)
```

### ä¸“é—¨èŒè´£
1. **å®æ—¶è®¾å¤‡çŠ¶æ€å¹¿æ’­** - å½“è®¾å¤‡çŠ¶æ€æ”¹å˜æ—¶ç«‹å³é€šçŸ¥æ‰€æœ‰è¿æ¥
2. **ä¼ æ„Ÿå™¨æ•°æ®æµ** - æŒç»­å‘é€ç¯å¢ƒä¼ æ„Ÿå™¨æ•°æ®
3. **è®¾å¤‡æ§åˆ¶ç¡®è®¤** - å‘é€è®¾å¤‡æ“ä½œç»“æœ

---

## ğŸ”„ æœåŠ¡é—´é€šä¿¡æµç¨‹

### å…¸å‹çš„è¯­éŸ³å‘½ä»¤å¤„ç†æµç¨‹ï¼š

```
1. ESP8266/æµè§ˆå™¨ â†’ WebSocket â†’ Coordinator (/ws)
   "Turn on living room lights"

2. Coordinator â†’ STT Service (HTTP)
   POST /upload (å¦‚æœæ˜¯éŸ³é¢‘)

3. Coordinator â†’ Ollama Service (HTTP)
   POST /api/generate (è¯­ä¹‰ç†è§£)

4. Coordinator â†’ IoT Service (HTTP)
   POST /control (è®¾å¤‡æ§åˆ¶)

5. IoT Service â†’ æ‰€æœ‰IoT WebSocketå®¢æˆ·ç«¯
   å¹¿æ’­è®¾å¤‡çŠ¶æ€æ›´æ–°

6. Coordinator â†’ TTS Service (HTTP)
   POST /synthesize (ç”Ÿæˆå›å¤è¯­éŸ³)

7. Coordinator â†’ åŸå§‹å®¢æˆ·ç«¯ (WebSocket)
   å‘é€å®Œæ•´å“åº” (æ–‡æœ¬+éŸ³é¢‘+IoTç»“æœ)
```

---

## ğŸ“Š è¯¦ç»†æœåŠ¡åˆ†å·¥

### 1. ğŸ¯ Coordinator Service (ç«¯å£ 8080)
```yaml
ä¸»è¦èŒè´£:
  - WebSocketä¸»ç®¡ç†å™¨ (ws://localhost:8080/ws)
  - ç”¨æˆ·è¯·æ±‚è·¯ç”±å’Œåè°ƒ
  - è¯­ä¹‰ç†è§£å’Œæ„å›¾è¯†åˆ«
  - æœåŠ¡é—´é€šä¿¡ç¼–æ’
  - å“åº”èšåˆå’Œæ ¼å¼åŒ–

HTTP API:
  - POST /process_text - æ–‡æœ¬å¤„ç†
  - POST /process_audio - éŸ³é¢‘å¤„ç†
  - POST /execute_scene - åœºæ™¯æ‰§è¡Œ
  - GET /room_status/{room} - æˆ¿é—´çŠ¶æ€

WebSocket æ¶ˆæ¯ç±»å‹:
  - text: æ–‡æœ¬å‘½ä»¤å¤„ç†
  - audio_ready: éŸ³é¢‘æ–‡ä»¶å¤„ç†
  - scene_command: åœºæ™¯æ¨¡å¼æ‰§è¡Œ
  - device_registration: è®¾å¤‡æ³¨å†Œ
```

### 2. ğŸ¤ STT Service (ç«¯å£ 8000)
```yaml
ä¸»è¦èŒè´£:
  - è¯­éŸ³è½¬æ–‡å­— (Whisper)
  - éŸ³é¢‘æ–‡ä»¶å¤„ç†
  - UDPéŸ³é¢‘æµæ¥æ”¶ (ESP32)

HTTP API:
  - POST /upload - ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶è½¬å½•
  - POST /transcribe - è½¬å½•æŒ‡å®šè·¯å¾„éŸ³é¢‘

ç‰¹æ®ŠåŠŸèƒ½:
  - UDPæœåŠ¡å™¨ (ç«¯å£8000) - æ¥æ”¶ESP32éŸ³é¢‘æµ
```

### 3. ğŸ”Š TTS Service (ç«¯å£ 8001)
```yaml
ä¸»è¦èŒè´£:
  - æ–‡å­—è½¬è¯­éŸ³ (Edge TTS)
  - éŸ³é¢‘æ–‡ä»¶ç”Ÿæˆå’Œç®¡ç†
  - å¤šè¯­è¨€è¯­éŸ³åˆæˆ

HTTP API:
  - POST /synthesize - è¯­éŸ³åˆæˆ
  - GET /voices - å¯ç”¨è¯­éŸ³åˆ—è¡¨
  - GET /audio/{filename} - ä¸‹è½½éŸ³é¢‘æ–‡ä»¶
  - POST /stream - æµå¼éŸ³é¢‘åˆæˆ
```

### 4. ğŸ  IoT Control Service Pro (ç«¯å£ 8002)

#### a. æ™ºèƒ½ä¼ æ„Ÿå™¨æ•°æ®ç®¡ç†

yaml

```yaml
çœŸå®æ•°æ®é›†æˆ:
  - æ”¯æŒESP8266çœŸå®ä¼ æ„Ÿå™¨æ•°æ®ä¸Šä¼ 
  - æ•°æ®æºæ ‡è¯†: real_dataæ ‡å¿—ä½
  - æ—¶æ•ˆæ€§ç®¡ç†: 5åˆ†é’Ÿå†…çš„æ•°æ®ä¼˜å…ˆä½¿ç”¨
  - è‡ªåŠ¨é™çº§: è¶…æ—¶ååˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ•°æ®

æ¨¡æ‹Ÿæ•°æ®å¼•æ“:
  - åŸºäºæ—¶é—´çš„ç¯å¢ƒå˜åŒ–æ¨¡æ‹Ÿ
  - è®¾å¤‡æ“ä½œçš„ç¯å¢ƒå½±å“è®¡ç®—
  - çœŸå®æ€§å¢å¼º: éšæœºå˜åŒ–+è¶‹åŠ¿æ¨¡æ‹Ÿ
  - å¤‡ç”¨æœºåˆ¶: ä¼ æ„Ÿå™¨æ•…éšœæ—¶æ— ç¼åˆ‡æ¢
```

#### b. å¢å¼ºçš„WebSocketåŠŸèƒ½

```python
# services/iot/app.py - WebSocketç«¯ç‚¹
@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    """å¢å¼ºå‹IoT WebSocket - æ”¯æŒçœŸå®æ•°æ®æµ"""
    
    # æ”¯æŒçš„æ¶ˆæ¯ç±»å‹:
    # - control: è®¾å¤‡æ§åˆ¶å‘½ä»¤
    # - get_sensors: è·å–ä¼ æ„Ÿå™¨æ•°æ®
    # - sensor_update: å®æ—¶ä¼ æ„Ÿå™¨æ›´æ–°å¹¿æ’­
    # - device_update: è®¾å¤‡çŠ¶æ€å˜åŒ–é€šçŸ¥
    # - ping/pong: è¿æ¥ä¿æ´»
```

#### c. ä¼ æ„Ÿå™¨æ•°æ®å¤„ç†API

```yaml
æ–°å¢APIç«¯ç‚¹:
  - GET /sensors/{location}/info - è¯¦ç»†ä¼ æ„Ÿå™¨ä¿¡æ¯
  - POST /sensors/{location}/reset_simulation - é‡ç½®æ¨¡æ‹Ÿæ¨¡å¼
  - GET /sensors - æ‰€æœ‰ä¼ æ„Ÿå™¨çŠ¶æ€
  - POST /control - å¢å¼ºè®¾å¤‡æ§åˆ¶ (æ”¯æŒä¼ æ„Ÿå™¨æ•°æ®æ›´æ–°)

æ•°æ®æ›´æ–°æœºåˆ¶:
  - å®æ—¶æ¥æ”¶ESP8266ä¼ æ„Ÿå™¨æ•°æ®
  - æ™ºèƒ½æ•°æ®éªŒè¯å’Œè¿‡æ»¤
  - å¤šæˆ¿é—´ç‹¬ç«‹æ•°æ®ç®¡ç†
  - å†å²æ•°æ®è¶‹åŠ¿åˆ†æ
```

#### d. è®¾å¤‡æ§åˆ¶çŸ©é˜µ

```yaml
æ”¯æŒè®¾å¤‡ç±»å‹:
  lighting:
    - ceiling_light: 5ä¸ªæˆ¿é—´ (äº®åº¦+è‰²æ¸©æ§åˆ¶)
    - desk_lamp: 2ä¸ªæˆ¿é—´ (æŠ¤çœ¼æ¨¡å¼)
    
  climate:
    - ac: 2ä¸ªæˆ¿é—´ (æ¸©åº¦+æ¨¡å¼+é£é€Ÿ)
    - fan: 3ä¸ªæˆ¿é—´ (é€Ÿåº¦+æ‘†åŠ¨)
    - exhaust_fan: 2ä¸ªæˆ¿é—´ (å®šæ—¶+é€Ÿåº¦)
    
  automation:
    - curtain: 4ä¸ªæˆ¿é—´ (ä½ç½®æ§åˆ¶0-100%)
    
  sensors:
    - temperature: å®æ—¶æ¸©åº¦ç›‘æ§
    - humidity: æ¹¿åº¦ç›‘æ§
    - co2: ç©ºæ°”è´¨é‡ç›‘æ§
    - voc: æœ‰æœºç‰©æ£€æµ‹
    - light_level: å…‰ç…§å¼ºåº¦
    - motion: è¿åŠ¨æ£€æµ‹
```

### 5. ğŸ§  Ollama Service (ç«¯å£ 11434)
```yaml
ä¸»è¦èŒè´£:
  - å¤§è¯­è¨€æ¨¡å‹æ¨ç†
  - è‡ªç„¶è¯­è¨€ç†è§£
  - æ™ºèƒ½å›å¤ç”Ÿæˆ

HTTP API:
  - POST /api/generate - æ–‡æœ¬ç”Ÿæˆ
  - POST /api/chat - å¯¹è¯æ¨¡å¼
  - GET /api/tags - å¯ç”¨æ¨¡å‹åˆ—è¡¨
  - POST /api/pull - ä¸‹è½½æ¨¡å‹
```

---

## ğŸ”Œ WebSocketè¿æ¥ç­–ç•¥

### ä¸»WebSocket (Coordinator)
```javascript
// ç”¨äºä¸»è¦çš„ç”¨æˆ·äº¤äº’
const mainWS = new WebSocket('ws://10.129.113.188:8080/ws');

// å‘é€å„ç§ç±»å‹çš„å‘½ä»¤
mainWS.send(JSON.stringify({
    type: 'text',
    text: 'Turn on lights'
}));

mainWS.send(JSON.stringify({
    type: 'scene_command',
    scene: 'sleep_mode'
}));
```

### IoTä¸“ç”¨WebSocket
```javascript
// ç”¨äºå®æ—¶è®¾å¤‡çŠ¶æ€ç›‘æ§
const iotWS = new WebSocket('ws://10.129.113.188:8002/ws');

// æ¥æ”¶è®¾å¤‡çŠ¶æ€æ›´æ–°
iotWS.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.type === 'device_update') {
        updateDeviceUI(data.device, data.state);
    }
};
```

---

## ğŸ­ ESP8266è¿æ¥ç­–ç•¥

å¯¹äºESP8266ï¼Œæ¨èè¿æ¥åˆ°**Coordinatorçš„ä¸»WebSocket**ï¼š

```cpp
// ESP8266åº”è¯¥è¿æ¥åˆ°ä¸»åè°ƒæœåŠ¡
WebSocketsClient webSocket;
webSocket.begin("10.129.113.188", 8080, "/ws");

// å‘é€è®¾å¤‡æ³¨å†Œ
void sendRegistration() {
    DynamicJsonDocument doc(512);
    doc["type"] = "device_registration";
    doc["device_info"]["type"] = "esp8266";
    doc["capabilities"][0] = "sensor";
    doc["capabilities"][1] = "actuator";
    
    String message;
    serializeJson(doc, message);
    webSocket.sendTXT(message);
}

// å‘é€ä¼ æ„Ÿå™¨æ•°æ®
void sendSensorData() {
    DynamicJsonDocument doc(256);
    doc["type"] = "sensor_data";
    doc["location"] = "living_room";
    doc["temperature"] = 23.5;
    doc["humidity"] = 55;
    
    String message;
    serializeJson(doc, message);
    webSocket.sendTXT(message);
}
```

---

## ğŸ“ˆ æ•°æ®æµå‘å›¾

```
ç”¨æˆ·å‘½ä»¤: "Turn on living room lights"
    â”‚
    â–¼
[Coordinator WebSocket] (/ws)
    â”‚
    â”œâ”€â†’ [Ollama] è¯­ä¹‰ç†è§£
    â”‚       â”‚
    â”‚       â–¼
    â”‚   "device=light, action=on, location=living_room"
    â”‚
    â”œâ”€â†’ [IoT Control] è®¾å¤‡æ§åˆ¶
    â”‚       â”‚
    â”‚       â”œâ”€â†’ æ›´æ–°è®¾å¤‡çŠ¶æ€
    â”‚       â””â”€â†’ [IoT WebSocket] å¹¿æ’­çŠ¶æ€å˜åŒ–
    â”‚
    â”œâ”€â†’ [TTS] ç”Ÿæˆè¯­éŸ³å›å¤
    â”‚       â”‚
    â”‚       â–¼
    â”‚   "lights_turned_on.mp3"
    â”‚
    â””â”€â†’ [Coordinator WebSocket] å‘é€å®Œæ•´å“åº”
            â”‚
            â–¼
        { 
          ai_response: "å·²ä¸ºæ‚¨æ‰“å¼€å®¢å…ç¯",
          audio_path: "/audio/response.mp3",
          iot_commands: [...],
          expression: "neutral"
        }
```

## ğŸ¯ æ€»ç»“

- **ä¸»WebSocketç®¡ç†å™¨**: Coordinator Service (8080ç«¯å£)
- **è®¾å¤‡çŠ¶æ€WebSocket**: IoT Control Service (8002ç«¯å£)  
- **æ¨èESP8266è¿æ¥**: Coordinator WebSocket (æ›´å…¨é¢çš„åŠŸèƒ½)
- **æµè§ˆå™¨å¯ä»¥è¿æ¥**: ä¸¤ä¸ªWebSocketéƒ½å¯ä»¥ï¼Œæ ¹æ®éœ€æ±‚é€‰æ‹©

ä½ çš„ESP8266åº”è¯¥ä¸»è¦è¿æ¥åˆ° `ws://10.129.113.188:8080/ws` æ¥è·å¾—å®Œæ•´çš„æ™ºèƒ½å®¶å±…åŠŸèƒ½ï¼